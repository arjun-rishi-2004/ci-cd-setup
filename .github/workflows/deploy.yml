name: Deploy Spring Boot App to EC2

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build JAR
        run: ./gradlew clean bootJar -x test

      - name: Build Docker Image
        run: |
          docker build -t my-app:latest .

      - name: Save Docker Image
        run: docker save my-app:latest -o my-app.tar

      - name: Set permissions for Docker image
        run: chmod 644 my-app.tar

      - name: Transfer Docker Image to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          source: "my-app.tar"
          target: "~/"

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: SSH into EC2 and Deploy Containers
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: -----BEGIN RSA PRIVATE KEY-----
                MIIEpAIBAAKCAQEA4Re44y5H54ITKXqCfmRJfH0TZQKXfS55bgZEIH1bd8AVoc5t
                QF+PFK7HtNa35eDQVZG3MD6BbqBQrORhX8sccCk3wNaFb2cfnQL7o89iHRJr4fiN
                rc1BSkxOOV0G7sFCjf6Fa5ZDWskeZpTSAyjBXjlh/A8YOC/oGf4FuMBXCRO8XpdT
                HtI72udhAXV0pqyvkTVU0bfcZ812dqDYnz/O3uHXiwXrr/FdiqvyaZm5+250sq2U
                Jm4yh5cWoeUUXVeDhIP9rC3oMVJdzRS0FkwjUXqmUoU3aCt40IU8kjl1+S9Os7M0
                w7xsmNlrVIrL7o3A3uNLuDAUSSS0VM1egs28SQIDAQABAoIBAGYI5tq0xAuBv0Xy
                Lu00cMtptzz2q80nIAxr8r33lVr3S9cJSCUCLE3n3Mdw/fPKsSXY4/2OmAWZznhR
                HoLaA44kYQ2dMOeLC52VGJTtEUC0dQr+LNs4S/xuEpeWP+pC2PSdB8X5W5bvzEQb
                +gdMljssL+qevQ/bR49gwx84sTt/SR2Np5GAyBI+D/SYyGrnLSxQXoGaNUrnwUsn
                kqrQZ7a4Y4djpwaKWlsQE7OH+pmTN6lL90OtDDoYqy1h88GBsXfawVvrtxq70Cv6
                3FM8EFntzuW60PJ9S8Bd4lLCPfdj9kJq2tKQZu3hFgPXUckCxPa0kYJZWnwy2JSg
                0jvBaAECgYEA9F/hezkFwwitzpaU0NmVjw2EwLInLuxveUUFo7HZaQSfHNrjA+zd
                dYkukb1VACiaaVnK6ZdabEgExcsTqxzOgp9W8jtt6uVc/u8+mDQDSVYWPZjZC6rd
                WyB183XhRQgeNZPIzXJ6rYOHu4WAwUqepnZeH1kCsQkjSVH43Xfwj8ECgYEA680E
                Ube+zwlA02/wJF9hKleo5vgpPwi/z1M9igt2/XQ7Zwi6caclaKGcaQSLv223Luoj
                6TEczlsau4Ci3lAaQ5Q9wGnHKtfpSAzKjyoCx6lw8tiKtojBXETQJmUjRnh6a7EF
                El+9i6usB8y342l4V01PpDHcT1BMPj2WXdhETokCgYArxMiD43Cuv+0xZTL+PRpW
                ZttyD/aIpvxIQh6CdSY1cwh0iJfEajY4CPv4Smrg/mS5ncWEFQGzBysjqf251gz+
                xD80X4SOX8pKNtuFMzurdOnC2o91UYMYATZfBqv0S0Ht4qxCb9CdJ0O2SHEJLa5A
                rk6pWq3qu3JAfZgPQp4pgQKBgQDACeJgoyLU/pY7HMkY9kzt7SJzqNv+qCN+uC5A
                RQINfSH70dH2SchfpG774GXn63Tq0mmYuxTYwr3MwwDhyZ76Nrrr/7njHKCyuygk
                3HQTI94HCXA/JLVFbg2Pl4LZG7moBy04P5zhKVkbqRCCNx15DE+2S50/Qwg1EHdr
                ynwm8QKBgQDwaDwkh+ahOwyBkmez4E3v+9Z06qZxTg1uvTDm8RsWDDSJOylmZfu6
                GWnCNvLXYR4Rxl0CiRBJsgKGklxgmllMvx7sOqH8gIWvUydtaSs19UszgvpF7nMs
                d8erKhyTjfW5oLSGGp4yGOmAnx7+UEXXRqLN+gZrAZ7rHtJhSPXnzQ==
              -----END RSA PRIVATE KEY-----
          script: |
            # Load the Docker image
            docker load -i ~/my-app.tar
            
            # Remove old containers if they exist
            docker stop emsp || true && docker rm emsp || true
            docker stop cpo || true && docker rm cpo || true

            # Run EMSP container
            docker run -d --name emsp -p 9443:9443 --restart always \
              -e "SPRING_PROFILES_ACTIVE=emsp" \
              -e "SCHEMA=emsp" \
              -e "SERVER_PORT=9443" \
              -e "SAAS_URL=https://localhost:9443/hooks" \
              -e "PUBLIC_URL=https://localhost:9443" \
              my-app:latest

            # Run CPO container
            docker run -d --name cpo -p 8443:8443 --restart always \
              -e "SPRING_PROFILES_ACTIVE=cpo" \
              -e "SCHEMA=cpo" \
              -e "SERVER_PORT=8443" \
              -e "SAAS_URL=https://localhost:8443/hooks" \
              -e "PUBLIC_URL=https://localhost:8443" \
              my-app:latest
