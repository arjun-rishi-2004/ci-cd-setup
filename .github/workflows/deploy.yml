name: Deploy Spring Boot App to EC2 or ECR

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment Target (ec2 or ecr)'
        required: true
        default: 'ec2'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build JAR
        run: ./gradlew clean bootJar -x test

      - name: Build Docker Image
        run: docker build -t ocpi_images .

      - name: Get Latest Tag
        id: get_version
        run: |
          LATEST_TAG=$(git tag --sort=-v:refname | grep 'ocpi-stack-dev-v' | head -n 1)
          echo "Latest tag: $LATEST_TAG"

          if [[ -z "$LATEST_TAG" ]]; then
            NEW_TAG="ocpi-stack-dev-v1.0.0"
          else
            BASE_VERSION=$(echo "$LATEST_TAG" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
            NEW_TAG="ocpi-stack-dev-v$(echo $BASE_VERSION | awk -F. '{print $1"."$2"."$3+1}')"
          fi
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create & Push New Tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git tag $NEW_TAG
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git $NEW_TAG


      - name: Tag Docker Image for ECR
        if: inputs.target == 'ecr'
        run: |
          docker tag ocpi_images:latest 148761650284.dkr.ecr.ap-south-1.amazonaws.com/ocpi_images:${{ steps.version.outputs.NEW_VERSION }}
          docker tag ocpi_images:latest 148761650284.dkr.ecr.ap-south-1.amazonaws.com/ocpi_images:latest

      - name: Configure AWS CLI
        if: inputs.target == 'ecr'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Login to Amazon ECR
        if: inputs.target == 'ecr'
        run: |
          aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin 148761650284.dkr.ecr.ap-south-1.amazonaws.com

      - name: Push Image to ECR
        if: inputs.target == 'ecr'
        run: |
          docker push 148761650284.dkr.ecr.ap-south-1.amazonaws.com/ocpi_images:${{ steps.version.outputs.NEW_VERSION }}
          docker push 148761650284.dkr.ecr.ap-south-1.amazonaws.com/ocpi_images:latest


      - name: Save Docker Image for EC2
        if: inputs.target == 'ec2'
        run: docker save ocpi_images -o ocpi_images.tar

      - name: Set permissions for Docker image
        if: inputs.target == 'ec2'
        run: chmod 644 ocpi_images.tar

      - name: Transfer Docker Image to EC2
        if: inputs.target == 'ec2'
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY_TEMP }}
          source: "ocpi_images.tar"
          target: "~/"
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: SSH into EC2 and Deploy from ECR
        if: inputs.target == 'ecr'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY_TEMP }}
          script: |
            aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin 148761650284.dkr.ecr.ap-south-1.amazonaws.com
            docker stop emsp || true && docker rm emsp || true
            docker stop cpo || true && docker rm cpo || true
            
            docker pull 148761650284.dkr.ecr.ap-south-1.amazonaws.com/ocpi_images:latest
            
            docker run -d --name emsp -p 9443:9443 --restart always \
              -e "SPRING_PROFILES_ACTIVE=emsp" \
              -e "SCHEMA=emsp" \
              -e "SERVER_PORT=9443" \
              -e "SAAS_URL=https://localhost:9443/hooks" \
              -e "PUBLIC_URL=https://localhost:9443" \
              148761650284.dkr.ecr.ap-south-1.amazonaws.com/ocpi_images:latest
            docker run -d --name cpo -p 8443:8443 --restart always \
              -e "SPRING_PROFILES_ACTIVE=cpo" \
              -e "SCHEMA=cpo" \
              -e "SERVER_PORT=8443" \
              -e "SAAS_URL=https://localhost:8443/hooks" \
              -e "PUBLIC_URL=https://localhost:8443" \
              148761650284.dkr.ecr.ap-south-1.amazonaws.com/ocpi_images:latest
      - name: SSH into EC2 and Deploy from Local Image
        if: inputs.target == 'ec2'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY_TEMP }}
          script: |
            docker load -i ~/ocpi_images.tar
            docker stop emsp || true && docker rm emsp || true
            docker stop cpo || true && docker rm cpo || true
            docker run -d --name emsp -p 9443:9443 --restart always \
              -e "SPRING_PROFILES_ACTIVE=emsp" \
              -e "SCHEMA=emsp" \
              -e "SERVER_PORT=9443" \
              -e "SAAS_URL=https://localhost:9443/hooks" \
              -e "PUBLIC_URL=https://localhost:9443" \
              ocpi_images:latest
            docker run -d --name cpo -p 8443:8443 --restart always \
              -e "SPRING_PROFILES_ACTIVE=cpo" \
              -e "SCHEMA=cpo" \
              -e "SERVER_PORT=8443" \
              -e "SAAS_URL=https://localhost:8443/hooks" \
              -e "PUBLIC_URL=https://localhost:8443" \
              ocpi_images:latest